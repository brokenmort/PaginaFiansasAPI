class userView(APIView):
    """
    Vista para obtener y actualizar informaciÃƒÂ³n del usuario autenticado.
    """
    permission_classes = [IsAuthenticated]  # Solo usuarios logueados

    @swagger_auto_schema(operation_summary='Perfil del usuario (detalle)', tags=['Usuarios'],
                        responses={200: openapi.Response('OK', examples={'application/json': {
                            'id': 1,
                            'email': 'user@mail.com',
                            'birthday': '2000-01-01',
                            'first_name': 'Nelson',
                            'last_name': 'Giraldo',
                            'phone': '3000000000',
                            'country': 'CO',
                            'profile_image': None
                        }})})
    def get(self, request):
        """
        Devuelve informaciÃƒÂ³n del usuario autenticado.
        """
        serializer = UserRegisterSerializer(request.user)  # Serializa datos del usuario
        return Response(serializer.data)  # Devuelve datos serializados en formato JSON

    @swagger_auto_schema(operation_summary='Actualizar perfil de usuario', tags=['Usuarios'],
                         request_body=openapi.Schema(
                            type=openapi.TYPE_OBJECT,
                            properties={
                              'first_name': openapi.Schema(type=openapi.TYPE_STRING, example='Nelson'),
                              'last_name': openapi.Schema(type=openapi.TYPE_STRING, example='Giraldo'),
                              'birthday': openapi.Schema(type=openapi.TYPE_STRING, example='2000-01-01'),
                              'phone': openapi.Schema(type=openapi.TYPE_STRING, example='3000000000'),
                              'country': openapi.Schema(type=openapi.TYPE_STRING, example='CO'),
                              'profile_image': openapi.Schema(type=openapi.TYPE_STRING, format='binary')
                            }
                         ))
    def put(self, request):
        """
        Actualiza datos del usuario, incluyendo imagen de perfil.
        """
        user = User.objects.get(id=request.user.id)  # Busca el usuario autenticado en BD
        serializer = UserUpdateSerializer(user, data=request.data, partial=True)  # Permite actualizaciÃƒÂ³n parcial
        if serializer.is_valid(raise_exception=True):  # Valida datos enviados
            serializer.save()  # Guarda cambios en la base de datos
            return Response(serializer.data)  # Devuelve datos actualizados
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)


# -----------------------------------------------------------
# SOLICITUD DE RESET DE CONTRASEÃƒâ€˜A
# -----------------------------------------------------------
class PasswordResetRequestView(APIView):
    """
    EnvÃƒÂ­a un cÃƒÂ³digo al correo para poder restablecer la contraseÃƒÂ±a.
    """
    permission_classes = [AllowAny]  # Cualquiera puede solicitarlo

    @swagger_auto_schema(operation_summary='Solicitar codigo de reseteo', tags=['Auth'],
        request_body=openapi.Schema(
            type=openapi.TYPE_OBJECT,
            required=['email'],
            properties={'email': openapi.Schema(type=openapi.TYPE_STRING, example='user@mail.com')}
        ),
        responses={200: openapi.Response('OK', examples={'application/json': {'detail': 'Codigo enviado'}})}
    )
    def post(self, request):
        serializer = PasswordResetRequestSerializer(data=request.data)  # Serializa datos recibidos
        serializer.is_valid(raise_exception=True)  # Valida datos

        email = serializer.validated_data["email"]  # Obtiene email
        try:
            user = User.objects.get(email=email)  # Busca usuario por email
        except User.DoesNotExist:
            return Response({"error": "No existe un usuario con ese correo."}, status=404)

        # Genera cÃƒÂ³digo aleatorio de 6 dÃƒÂ­gitos
        token = str(random.randint(100000, 999999))

        # Crea registro de token para ese usuario
        PasswordResetToken.objects.create(user=user, token=token)

        # EnvÃƒÂ­a correo real usando SMTP configurado en settings.py
        send_mail(
            subject="RecuperaciÃƒÂ³n de contraseÃƒÂ±a",
            message=f"Tu cÃƒÂ³digo de recuperaciÃƒÂ³n es: {token}",
            from_email=settings.DEFAULT_FROM_EMAIL,
            recipient_list=[email],
            fail_silently=False  # Lanza error si no se puede enviar
        )

        return Response({"message": "Se ha enviado un cÃƒÂ³digo al correo."}, status=200)


# -----------------------------------------------------------
# VERIFICACIÃƒâ€œN DE TOKEN DE RECUPERACIÃƒâ€œN
# -----------------------------------------------------------
class PasswordResetVerifyView(APIView):
    """
    Verifica que el token enviado al correo sea vÃƒÂ¡lido.
    """
    permission_classes = [AllowAny]

    def post(self, request):
        serializer = PasswordResetVerifySerializer(data=request.data)  # Valida email y token
        serializer.is_valid(raise_exception=True)

        email = serializer.validated_data["email"]
        token = serializer.validated_data["token"]

        try:
            user = User.objects.get(email=email)  # Busca usuario
            reset_token = PasswordResetToken.objects.filter(user=user, token=token).last()  # Busca ÃƒÂºltimo token
        except User.DoesNotExist:
            return Response({"error": "Usuario no encontrado."}, status=404)

        # Comprueba si token sigue siendo vÃƒÂ¡lido
        if reset_token and reset_token.is_valid():
            return Response({"valid": True}, status=200)

        return Response({"valid": False}, status=400)


# -----------------------------------------------------------
# CONFIRMAR Y CAMBIAR CONTRASEÃƒâ€˜A
# -----------------------------------------------------------
class PasswordResetConfirmView(APIView):
    """
    Permite establecer nueva contraseÃƒÂ±a si el token es vÃƒÂ¡lido.
    """
    permission_classes = [AllowAny]

    @swagger_auto_schema(operation_summary='Confirmar reseteo de contrasena', tags=['Auth'],
        request_body=openapi.Schema(
            type=openapi.TYPE_OBJECT,
            required=['email','token','new_password'],
            properties={
                'email': openapi.Schema(type=openapi.TYPE_STRING, example='user@mail.com'),
                'token': openapi.Schema(type=openapi.TYPE_STRING, example='123456'),
                'new_password': openapi.Schema(type=openapi.TYPE_STRING, example='newPass123')
            }
        ),
        responses={200: openapi.Response('OK', examples={'application/json': {'message': 'Contrasena actualizada y sesiones cerradas.'}})}
    )
    def post(self, request):
        serializer = PasswordResetConfirmSerializer(data=request.data)  # Valida datos recibidos
        serializer.is_valid(raise_exception=True)

        email = serializer.validated_data["email"]
        token = serializer.validated_data["token"]
        new_password = serializer.validated_data["new_password"]

        try:
            user = User.objects.get(email=email)  # Busca usuario
            reset_token = PasswordResetToken.objects.filter(user=user, token=token).last()
        except User.DoesNotExist:
            return Response({"error": "Usuario no encontrado."}, status=404)

        if reset_token and reset_token.is_valid():
            user.set_password(new_password)  # Cambia contraseÃƒÂ±a
            user.save()

            # Revoca todos los tokens JWT anteriores para cerrar sesiones activas
            for outstanding_token in OutstandingToken.objects.filter(user=user):
                BlacklistedToken.objects.get_or_create(token=outstanding_token)

            # Elimina token usado
            reset_token.delete()
            return Response({"message": "ContraseÃƒÂ±a actualizada y sesiones cerradas."}, status=200)

        return Response({"error": "Token invÃƒÂ¡lido o expirado."}, status=400)


# -----------------------------------------------------------
# LOGIN Y REFRESH DE TOKENS JWT
# -----------------------------------------------------------
class LoginView(TokenObtainPairView):
    """
    Genera par de tokens (access y refresh) al iniciar sesiÃƒÂ³n.
    """
    permission_classes = [AllowAny]

    @swagger_auto_schema(
        operation_summary='Login (JWT pair)',
        tags=['Auth'],
        request_body=openapi.Schema(
            type=openapi.TYPE_OBJECT,
            required=['email', 'password'],
            properties={
                'email': openapi.Schema(type=openapi.TYPE_STRING, example='user@mail.com'),
                'password': openapi.Schema(type=openapi.TYPE_STRING, example='******'),
            }
        ),
        responses={
            200: openapi.Response(
                description='Tokens',
                schema=openapi.Schema(
                    type=openapi.TYPE_OBJECT,
                    properties={
                        'access': openapi.Schema(type=openapi.TYPE_STRING),
                        'refresh': openapi.Schema(type=openapi.TYPE_STRING),
                    }
                ),
                examples={'application/json': {
                    'access': 'eyJhbGciOi...access...',
                    'refresh': 'eyJhbGciOi...refresh...'
                }}
            )
        }
    )
    def post(self, request, *args, **kwargs):
        return super().post(request, *args, **kwargs)


class RefreshView(TokenRefreshView):
    """
    Permite refrescar token de acceso usando refresh token.
    """
    permission_classes = [AllowAny]

    @swagger_auto_schema(
        operation_summary='Refrescar access token',
        tags=['Auth'],
        request_body=openapi.Schema(
            type=openapi.TYPE_OBJECT,
            required=['refresh'],
            properties={'refresh': openapi.Schema(type=openapi.TYPE_STRING)}
        ),
        responses={
            200: openapi.Response(
                description='Nuevo access',
                schema=openapi.Schema(
                    type=openapi.TYPE_OBJECT,
                    properties={'access': openapi.Schema(type=openapi.TYPE_STRING)}
                ),
                examples={'application/json': {'access': 'eyJhbGciOi...access...'}}
            )
        }
    )
    def post(self, request, *args, **kwargs):
        return super().post(request, *args, **kwargs)


# -----------------------------------------------------------
# LOGOUT DE USUARIO
# -----------------------------------------------------------
class LogoutView(APIView):
    """
    Revoca tokens JWT para cerrar sesiÃƒÂ³n del usuario.
    """
    permission_classes = [permissions.IsAuthenticated]

    @swagger_auto_schema(
        operation_summary='Logout (revocar tokens)',
        tags=['Auth'],
        request_body=openapi.Schema(
            type=openapi.TYPE_OBJECT,
            properties={'refresh': openapi.Schema(type=openapi.TYPE_STRING)},
            description='Opcional: si no se envÃƒÂ­a refresh, se revocan todos los tokens del usuario.'
        )
    )
    def post(self, request):
        try:
            refresh_token = request.data.get("refresh", None)  # Obtiene token refresh enviado
            if refresh_token:
                token = RefreshToken(refresh_token)
                token.blacklist()  # Revoca token especÃƒÂ­fico
                return Response({"detail": "Logout exitoso (refresh token revocado)."}, status=status.HTTP_205_RESET_CONTENT)
            
            # Si no se envÃƒÂ­a refresh, revoca todos los tokens del usuario
            tokens = OutstandingToken.objects.filter(user=request.user)
            for token in tokens:
                BlacklistedToken.objects.get_or_create(token=token)
            
            return Response({"detail": "Logout exitoso (todos los tokens revocados)."}, status=status.HTTP_205_RESET_CONTENT)
        except Exception as e:
            return Response({"error": str(e)}, status=status.HTTP_400_BAD_REQUEST)


# -----------------------------------------------------------
# VISTA DE INFORMACIÃƒâ€œN BÃƒÂSICA DEL USUARIO
# -----------------------------------------------------------
class UserInfoView(APIView):
    """
    Devuelve informaciÃƒÂ³n bÃƒÂ¡sica del usuario autenticado.
    """
    permission_classes = [permissions.IsAuthenticated]

    @swagger_auto_schema(operation_summary='Info basica del usuario', tags=['Usuarios'],
                        responses={200: openapi.Response('OK', examples={'application/json': {
                            'username': None,
                            'email': 'user@mail.com',
                            'id': 1,
                            'profile_image': None
                        }})})
    def get(self, request):
        user = request.user  # Obtiene usuario autenticado
        return Response({
            "username": user.username,
            "email": user.email,
            "id": user.id,
            "profile_image": user.profile_image.url if user.profile_image else None  # Devuelve URL de la imagen
        })


def _is_superuser(user):
    return user.is_authenticated and user.is_superuser

@login_required
@user_passes_test(_is_superuser)
@transaction.atomic
def approve_signup_view(request, token: str):
    """
    Endpoint al que llega el botÃƒÂ³n 'Aceptar solicitud'.
    Requiere que el usuario estÃƒÂ© autenticado y sea superusuario.
    """
    if request.method != "GET":
        return HttpResponseBadRequest("MÃƒÂ©todo no permitido.")
    try:
        approve_signup_and_send_code(token)
    except Exception as e:
        return HttpResponseBadRequest(f"Error: {e}")
    return HttpResponse("Solicitud aprobada y cÃƒÂ³digo enviado al solicitante.")



